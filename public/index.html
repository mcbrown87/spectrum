<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spectrum - Multiplayer Ranking Game</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>ðŸŽ® Spectrum</h1>
        <h2>Choose Your Adventure</h2>
        
        <!-- Home Screen - Choose Host or Join -->
        <div id="home-screen">
            <p>Rank your friends on hilarious personality spectrums!</p>
            
            <div class="choice-buttons">
                <button id="host-game-btn" class="choice-btn">
                    <div class="choice-icon">ðŸŽ¯</div>
                    <div class="choice-title">Host Game</div>
                    <div class="choice-desc">Create a new game room</div>
                </button>
                
                <button id="join-game-btn" class="choice-btn">
                    <div class="choice-icon">ðŸ“±</div>
                    <div class="choice-title">Join Game</div>
                    <div class="choice-desc">Enter a room code</div>
                </button>
            </div>
        </div>

        <!-- Host Game Flow -->
        <div id="host-flow" class="hidden">
            <!-- Game Creation Screen -->
            <div id="create-screen">
                <h2>Host a Game</h2>
                <p>Enter your name and create a new game session</p>
                
                <div class="input-group">
                    <input 
                        type="text" 
                        id="host-name-input" 
                        placeholder="Your Name" 
                        maxlength="20"
                        autocomplete="off"
                    >
                </div>
                
                <button id="create-game-btn">Create Game</button>
                <button id="back-to-home-btn" class="secondary-btn">Back</button>
            </div>

            <!-- Game Lobby Screen -->
            <div id="lobby-screen" class="hidden">
                <h2>Game Lobby</h2>
                <div class="game-code" id="game-code"></div>
                <p>Share this code with your friends to join!</p>
                
                <div class="status waiting">
                    <span id="player-count">0</span> players connected
                </div>

                <div class="players-list">
                    <h3>Players:</h3>
                    <div id="players-container">
                        <p style="opacity: 0.7;">Waiting for players to join...</p>
                    </div>
                </div>

                <button id="start-game-btn" disabled>Start Game</button>
                <button id="new-game-btn" class="secondary-btn">Create New Game</button>
            </div>
        </div>

        <!-- Join Game Flow -->
        <div id="join-flow" class="hidden">
            <h2>Join Game</h2>
            <p>Enter the game code to join your friends</p>
            
            <div class="input-group">
                <input 
                    type="text" 
                    id="game-code-input" 
                    placeholder="Game Code" 
                    maxlength="6"
                    autocomplete="off"
                >
            </div>
            
            <div class="input-group">
                <input 
                    type="text" 
                    id="player-name-input" 
                    placeholder="Your Name" 
                    maxlength="20"
                    autocomplete="off"
                >
            </div>
            
            <button id="join-game-submit-btn">Join Game</button>
            <button id="back-to-home-from-join-btn" class="secondary-btn">Back</button>

            <!-- Player Lobby Screen -->
            <div id="player-lobby-screen" class="hidden">
                <h2>Waiting for Game</h2>
                <div class="game-code" id="joined-game-code"></div>
                
                <div class="status waiting">
                    <span id="player-count-join">0</span> players connected
                </div>

                <div class="players-list">
                    <h3>Players in Game:</h3>
                    <div id="players-container-join">
                        <p style="opacity: 0.7;">Loading players...</p>
                    </div>
                </div>

                <div class="status waiting">
                    Waiting for host to start the game...
                </div>

                <button id="leave-game-btn" class="secondary-btn">Leave Game</button>
            </div>
        </div>

        <!-- Game Screens -->
        <div id="game-screen" class="hidden">
            <!-- Ranking Phase -->
            <div id="ranking-screen" class="hidden">
                <h2>Round <span id="current-round-number">1</span></h2>
                <div class="prompt-display">
                    <p id="current-prompt">Rank players by height (tallest to shortest)</p>
                </div>
                
                <div class="ranking-interface">
                    <h3>Drag to rank all players (including yourself):</h3>
                    <div id="ranking-list" class="ranking-list">
                        <!-- Players will be populated here -->
                    </div>
                </div>
                
                <div class="submission-status">
                    <p id="submission-progress">0 of 0 players have submitted</p>
                </div>
                
                <button id="submit-ranking-btn" disabled>Submit Ranking</button>
            </div>

            <!-- Results Phase -->
            <div id="results-screen" class="hidden">
                <h2>Round <span id="results-round-number">1</span> Results</h2>
                
                <div class="consensus-ranking">
                    <h3>Group Consensus:</h3>
                    <div id="consensus-display" class="consensus-list">
                        <!-- Consensus ranking will be shown here -->
                    </div>
                </div>
                
                <div class="round-scores">
                    <h3>Round Scores:</h3>
                    <div id="round-scores-display" class="scores-list">
                        <!-- Round scores will be shown here -->
                    </div>
                </div>
                
                <div class="total-scores">
                    <h3>Total Scores:</h3>
                    <div id="total-scores-display" class="scores-list">
                        <!-- Total scores will be shown here -->
                    </div>
                </div>
                
                <button id="next-round-btn" class="hidden">Next Round</button>
                <button id="view-final-results-btn" class="hidden">View Final Results</button>
            </div>

            <!-- Final Results Screen -->
            <div id="final-results-screen" class="hidden">
                <h2>ðŸŽ‰ Game Complete!</h2>
                
                <div class="final-scores">
                    <h3>Final Scores:</h3>
                    <div id="final-scores-display" class="scores-list">
                        <!-- Final scores will be shown here -->
                    </div>
                </div>
                
                <button id="play-again-btn">Play Again</button>
                <button id="back-to-home-final-btn" class="secondary-btn">Back to Home</button>
            </div>
        </div>

        <div id="status-message" class="status hidden"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        
        // Screen elements
        const homeScreen = document.getElementById('home-screen');
        const hostFlow = document.getElementById('host-flow');
        const joinFlow = document.getElementById('join-flow');
        const createScreen = document.getElementById('create-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        const playerLobbyScreen = document.getElementById('player-lobby-screen');
        
        // Home buttons
        const hostGameBtn = document.getElementById('host-game-btn');
        const joinGameBtn = document.getElementById('join-game-btn');
        
        // Host elements
        const hostNameInput = document.getElementById('host-name-input');
        const createGameBtn = document.getElementById('create-game-btn');
        const startGameBtn = document.getElementById('start-game-btn');
        const newGameBtn = document.getElementById('new-game-btn');
        const backToHomeBtn = document.getElementById('back-to-home-btn');
        const gameCodeEl = document.getElementById('game-code');
        const playersContainer = document.getElementById('players-container');
        const playerCountEl = document.getElementById('player-count');
        
        // Join elements
        const gameCodeInput = document.getElementById('game-code-input');
        const playerNameInput = document.getElementById('player-name-input');
        const joinGameSubmitBtn = document.getElementById('join-game-submit-btn');
        const backToHomeFromJoinBtn = document.getElementById('back-to-home-from-join-btn');
        const leaveGameBtn = document.getElementById('leave-game-btn');
        const joinedGameCodeEl = document.getElementById('joined-game-code');
        const playersContainerJoin = document.getElementById('players-container-join');
        const playerCountJoinEl = document.getElementById('player-count-join');
        
        const statusMessage = document.getElementById('status-message');

        // Game screen elements
        const gameScreen = document.getElementById('game-screen');
        const rankingScreen = document.getElementById('ranking-screen');
        const resultsScreen = document.getElementById('results-screen');
        const finalResultsScreen = document.getElementById('final-results-screen');
        
        const currentRoundNumber = document.getElementById('current-round-number');
        const currentPrompt = document.getElementById('current-prompt');
        const rankingList = document.getElementById('ranking-list');
        const submissionProgress = document.getElementById('submission-progress');
        const submitRankingBtn = document.getElementById('submit-ranking-btn');
        
        const resultsRoundNumber = document.getElementById('results-round-number');
        const consensusDisplay = document.getElementById('consensus-display');
        const roundScoresDisplay = document.getElementById('round-scores-display');
        const totalScoresDisplay = document.getElementById('total-scores-display');
        const nextRoundBtn = document.getElementById('next-round-btn');
        const viewFinalResultsBtn = document.getElementById('view-final-results-btn');
        
        const finalScoresDisplay = document.getElementById('final-scores-display');
        const playAgainBtn = document.getElementById('play-again-btn');
        const backToHomeFinalBtn = document.getElementById('back-to-home-final-btn');

        let currentGame = null;
        let isHost = false;
        let currentRanking = [];

        function showStatus(message, type = 'success') {
            statusMessage.textContent = message;
            statusMessage.className = `status ${type}`;
            statusMessage.classList.remove('hidden');
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 3000);
        }

        function showScreen(screen) {
            [homeScreen, hostFlow, joinFlow, gameScreen].forEach(s => s.classList.add('hidden'));
            screen.classList.remove('hidden');
        }

        function showSubScreen(subScreen) {
            [createScreen, lobbyScreen, playerLobbyScreen].forEach(s => s.classList.add('hidden'));
            subScreen.classList.remove('hidden');
        }

        function showGameScreen(gameSubScreen) {
            [rankingScreen, resultsScreen, finalResultsScreen].forEach(s => s.classList.add('hidden'));
            gameSubScreen.classList.remove('hidden');
        }

        function updatePlayersList(players, isJoinFlow = false) {
            const container = isJoinFlow ? playersContainerJoin : playersContainer;
            const countEl = isJoinFlow ? playerCountJoinEl : playerCountEl;
            
            if (players.length === 0) {
                container.innerHTML = '<p style="opacity: 0.7;">Waiting for players to join...</p>';
            } else {
                container.innerHTML = players.map(player => {
                    const hostBadge = player.isHost ? ' <span style="opacity: 0.7; font-size: 0.9em;">ðŸ‘‘ Host</span>' : '';
                    return `<div class="player">${player.name}${hostBadge}</div>`;
                }).join('');
            }
            
            countEl.textContent = players.length;
            if (!isJoinFlow) {
                startGameBtn.disabled = players.length < 2;
            }
        }

        // Home screen navigation
        hostGameBtn.addEventListener('click', () => {
            isHost = true;
            showScreen(hostFlow);
            showSubScreen(createScreen);
        });

        joinGameBtn.addEventListener('click', () => {
            isHost = false;
            showScreen(joinFlow);
        });

        // Back buttons
        backToHomeBtn.addEventListener('click', () => {
            showScreen(homeScreen);
            hostNameInput.value = '';
            currentGame = null;
        });

        backToHomeFromJoinBtn.addEventListener('click', () => {
            showScreen(homeScreen);
            gameCodeInput.value = '';
            playerNameInput.value = '';
        });

        // Add keyboard support for host name input
        hostNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                createGame();
            }
        });

        // Host game creation
        function createGame() {
            const hostName = hostNameInput.value.trim();

            if (!hostName || hostName.length < 1) {
                showStatus('Please enter your name', 'error');
                return;
            }

            createGameBtn.disabled = true;
            createGameBtn.textContent = 'Creating...';

            socket.emit('create-game', { hostName }, (response) => {
                createGameBtn.disabled = false;
                createGameBtn.textContent = 'Create Game';

                if (response.success) {
                    currentGame = response.game;
                    gameCodeEl.textContent = response.game.code;
                    showSubScreen(lobbyScreen);
                    updatePlayersList(response.game.players);
                    showStatus('Game created successfully!');
                } else {
                    showStatus('Failed to create game', 'error');
                }
            });
        }

        createGameBtn.addEventListener('click', createGame);

        newGameBtn.addEventListener('click', () => {
            showSubScreen(createScreen);
            hostNameInput.value = '';
            currentGame = null;
        });

        startGameBtn.addEventListener('click', () => {
            if (!currentGame || !currentGame.code) {
                showStatus('No game found', 'error');
                return;
            }

            startGameBtn.disabled = true;
            startGameBtn.textContent = 'Starting...';

            socket.emit('start-game', { gameCode: currentGame.code }, (response) => {
                startGameBtn.disabled = false;
                startGameBtn.textContent = 'Start Game';

                if (response.success) {
                    showStatus('Game started!', 'success');
                } else {
                    showStatus(response.error || 'Failed to start game', 'error');
                }
            });
        });

        // Join game functionality
        gameCodeInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
        });

        [gameCodeInput, playerNameInput].forEach(input => {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    joinGame();
                }
            });
        });

        function joinGame() {
            const gameCode = gameCodeInput.value.trim();
            const playerName = playerNameInput.value.trim();

            if (!gameCode || gameCode.length < 3) {
                showStatus('Please enter a valid game code', 'error');
                return;
            }

            if (!playerName || playerName.length < 1) {
                showStatus('Please enter your name', 'error');
                return;
            }

            joinGameSubmitBtn.disabled = true;
            joinGameSubmitBtn.textContent = 'Joining...';

            socket.emit('join-game', { gameCode, playerName }, (response) => {
                joinGameSubmitBtn.disabled = false;
                joinGameSubmitBtn.textContent = 'Join Game';

                if (response.success) {
                    currentGame = response.game;
                    joinedGameCodeEl.textContent = gameCode;
                    showSubScreen(playerLobbyScreen);
                    updatePlayersList(response.game.players, true);
                    showStatus('Successfully joined the game!');
                } else {
                    showStatus(response.error, 'error');
                }
            });
        }

        joinGameSubmitBtn.addEventListener('click', joinGame);

        leaveGameBtn.addEventListener('click', () => {
            socket.disconnect();
            socket.connect();
            showScreen(homeScreen);
            gameCodeInput.value = '';
            playerNameInput.value = '';
            currentGame = null;
            showStatus('Left the game', 'waiting');
        });

        // Socket events
        socket.on('player-joined', (data) => {
            if (currentGame) {
                currentGame.players = data.players;
                updatePlayersList(data.players, !isHost);
                showStatus(`${data.playerName} joined the game!`);
            }
        });

        socket.on('player-left', (data) => {
            if (currentGame) {
                currentGame.players = data.players;
                updatePlayersList(data.players, !isHost);
                showStatus('A player left the game', 'waiting');
            }
        });

        socket.on('disconnect', () => {
            if (currentGame && !isHost) {
                showStatus('Connection lost. Please rejoin.', 'error');
                setTimeout(() => {
                    showScreen(homeScreen);
                    currentGame = null;
                }, 2000);
            }
        });

        // Game flow socket events
        socket.on('game-started', (data) => {
            currentRoundNumber.textContent = data.currentRound;
            currentPrompt.textContent = data.prompt;
            
            // Initialize ranking list with all players including current player
            createRankingInterface(data.players);
            showScreen(gameScreen);
            showGameScreen(rankingScreen);
            showStatus('Round started! Rank the players.', 'success');
        });

        socket.on('ranking-submitted', (data) => {
            submissionProgress.textContent = `${data.submittedCount} of ${data.totalPlayers} players have submitted`;
        });

        socket.on('round-results', (data) => {
            resultsRoundNumber.textContent = data.currentRound;
            
            // Show consensus ranking
            consensusDisplay.innerHTML = data.consensusRanking.map((name, index) => 
                `<div class="consensus-item">
                    <span class="consensus-position">${index + 1}.</span>
                    <span>${name}</span>
                </div>`
            ).join('');

            // Show round scores
            const roundScoreEntries = Object.entries(data.roundScores).sort((a, b) => b[1] - a[1]);
            roundScoresDisplay.innerHTML = roundScoreEntries.map(([name, score]) =>
                `<div class="score-item">
                    <span>${name}</span>
                    <span class="score-value">+${score}</span>
                </div>`
            ).join('');

            // Show total scores
            const totalScoreEntries = Object.entries(data.totalScores).sort((a, b) => b[1] - a[1]);
            totalScoresDisplay.innerHTML = totalScoreEntries.map(([name, score]) =>
                `<div class="score-item">
                    <span>${name}</span>
                    <span class="score-value">${score}</span>
                </div>`
            ).join('');

            // Show appropriate button for host
            if (isHost) {
                nextRoundBtn.classList.remove('hidden');
                viewFinalResultsBtn.classList.add('hidden');
            }

            showGameScreen(resultsScreen);
            showStatus('Round complete! See the results.', 'success');
        });

        socket.on('new-round', (data) => {
            currentRoundNumber.textContent = data.roundNumber;
            currentPrompt.textContent = data.prompt;
            
            // Reset ranking interface for new round with all players
            const allPlayerNames = currentGame.players.map(p => p.name);
            
            createRankingInterface(allPlayerNames);
            showGameScreen(rankingScreen);
            showStatus(`Round ${data.roundNumber} started!`, 'success');
        });

        socket.on('game-finished', (data) => {
            // Show final scores
            const finalScoreEntries = Object.entries(data.finalScores).sort((a, b) => b[1] - a[1]);
            finalScoresDisplay.innerHTML = finalScoreEntries.map(([name, score]) =>
                `<div class="score-item">
                    <span>${name}</span>
                    <span class="score-value">${score}</span>
                </div>`
            ).join('');

            showGameScreen(finalResultsScreen);
            showStatus('Game complete! ðŸŽ‰', 'success');
        });

        // Game interaction functions
        function createRankingInterface(playerNames) {
            currentRanking = [...playerNames]; // Initialize with original order
            renderRankingList();
        }

        function renderRankingList() {
            rankingList.innerHTML = currentRanking.map((name, index) =>
                `<div class="ranking-item" draggable="true" data-player="${name}">
                    <span class="ranking-position">${index + 1}</span>
                    <span>${name}</span>
                </div>`
            ).join('');

            // Add drag and drop functionality
            addDragAndDropHandlers();
            
            // Enable submit button when ranking is modified
            submitRankingBtn.disabled = false;
        }

        function addDragAndDropHandlers() {
            const items = rankingList.querySelectorAll('.ranking-item');
            
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
        }

        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDrop(e) {
            e.preventDefault();
            
            if (this !== draggedElement) {
                const draggedPlayer = draggedElement.dataset.player;
                const targetPlayer = this.dataset.player;
                
                const draggedIndex = currentRanking.indexOf(draggedPlayer);
                const targetIndex = currentRanking.indexOf(targetPlayer);
                
                // Remove dragged item and insert at new position
                currentRanking.splice(draggedIndex, 1);
                currentRanking.splice(targetIndex, 0, draggedPlayer);
                
                renderRankingList();
            }
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedElement = null;
        }

        // Game button event handlers
        submitRankingBtn.addEventListener('click', () => {
            if (!currentGame || currentRanking.length === 0) {
                showStatus('No ranking to submit', 'error');
                return;
            }

            submitRankingBtn.disabled = true;
            submitRankingBtn.textContent = 'Submitting...';

            socket.emit('submit-ranking', { 
                gameCode: currentGame.code, 
                ranking: currentRanking 
            }, (response) => {
                if (response.success) {
                    submitRankingBtn.textContent = 'Submitted âœ“';
                    showStatus('Ranking submitted! Waiting for other players...', 'success');
                } else {
                    submitRankingBtn.disabled = false;
                    submitRankingBtn.textContent = 'Submit Ranking';
                    showStatus(response.error || 'Failed to submit ranking', 'error');
                }
            });
        });

        nextRoundBtn.addEventListener('click', () => {
            if (!currentGame) return;

            nextRoundBtn.disabled = true;
            socket.emit('next-round', { gameCode: currentGame.code }, (response) => {
                nextRoundBtn.disabled = false;
                if (!response.success) {
                    showStatus(response.error || 'Failed to advance round', 'error');
                }
                if (response.gameFinished) {
                    nextRoundBtn.classList.add('hidden');
                }
            });
        });

        playAgainBtn.addEventListener('click', () => {
            showScreen(homeScreen);
            currentGame = null;
            isHost = false;
        });

        backToHomeFinalBtn.addEventListener('click', () => {
            showScreen(homeScreen);
            currentGame = null;
            isHost = false;
        });
    </script>
</body>
</html>